Investigate dashboard security

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/index.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/manifest.json)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/models)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/index.ts#1-1), lines 1 to 200

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/package.json)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/types)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/middleware.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/next.config.mjs)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/ApiManager.ts#1-1), lines 1 to 300

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/WebSocketManager.ts#1-1), lines 1 to 300

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/dashboardPermissions.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/ApiManager.ts#300-300), lines 300 to 824

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/WebSocketManager.ts#300-300), lines 300 to 389

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/auth.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/api.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/permissions.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/discord.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/botOwner.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/cache.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/routePermissions.ts#1-1), lines 1 to 200

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/permissionDefs.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/runtimeConfig.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/websocket.tsx)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/guildCache.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/types/next-auth.d.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/dashboardRoutePermissions.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/auth)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/guilds)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/bot-owner)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/mutual-guilds)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/health)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/dashboard-access)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/runtime-config)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/dev)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/auth/%5B...nextauth%5D/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/guilds/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/guilds/%5BguildId%5D)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/bot-owner/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/mutual-guilds/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/health/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/dashboard-access/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/runtime-config/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/guilds/%5BguildId%5D/%5B...path%5D/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/guilds/%5BguildId%5D/status/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/guilds/%5BguildId%5D/user-permissions/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/dev/migrate)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/models/DashboardPermission.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/models/DashboardSettings.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/dev/migrate/route.ts)

Searched for files matching `**/bot/plugins/*/api/**/*.ts`, 20 matches

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/modmail/websocket)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/PermissionService.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/PermissionRegistry.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/broadcast.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/modmail/websocket/ModmailWebSocketService.ts#1-1), lines 1 to 300

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/index.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/modmail/api/index.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/moderation/api/rules-create.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/vc-transcription/api/apikey.ts#1-1), lines 1 to 100

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/tickets/api/index.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/utils/env.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/.gitignore)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/rcon.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/moderation/api/presets.ts#1-1), lines 1 to 100

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/players.ts#1-1), lines 1 to 200

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/dashboardPermissionDefs.ts#1-1), lines 1 to 100

Searched for regex `hardcoded|password|secret|credential` (`**/bot/plugins/dashboard/**`), 20 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/config.ts)

Searched for text `rconPassword` (`**/bot/plugins/minecraft/**`), 8 results

Searched for regex `regex|RegExp|\\$regex` (`**/bot/plugins/*/api/**`), 20 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/login/page.tsx#1-1), lines 1 to 50

Searched for regex `X-Content-Security-Policy|Content-Security-Policy|CSP|helmet`, 2 results

Searched for regex `new RegExp\(.*\$` (`**/bot/plugins/*/api/**`), 4 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/modmail/api/conversations.ts#270-270), lines 270 to 300

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/players.ts#50-50), lines 50 to 80

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/players.ts#90-90), lines 90 to 120

Searched for regex `rate.limit|rateLimit|rate_limit|throttle|express-rate`, 20 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/connection.ts#30-30), lines 30 to 80

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/players.ts#480-480), lines 480 to 540

Searched for regex `allowedDevOrigins`, 1 result

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/layout.tsx)

Searched for regex `INTERNAL_API_KEY|X-API-Key`, 30 results

Excellent — comprehensive findings. Let me gather a few more details on specific items before presenting the plan.

Deep dive edge cases

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/guilds/%5BguildId%5D/%5B...path%5D/route.ts)

Searched for files matching `**/bot/plugins/dashboard/app/lib/routePermissions.ts`, 1 match

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/PermissionService.ts)

Searched for regex `zod|z\.object|validate|schema` (`**/bot/plugins/*/api/**`), 20 results

Searched for files matching `**/bot/plugins/dashboard/app/app/api/auth/**`, 1 match

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/.gitignore)

Searched for files matching `**/bot/plugins/dashboard/app/**/*websocket*`, 1 match

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/routePermissions.ts#1-1), lines 1 to 200

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/app/api/auth/%5B...nextauth%5D/route.ts)

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/websocket.tsx)

Searched for regex `\$where|eval\(|\.aggregate\(\[.*\$|raw\(|exec\(|unsanitized|\.find\(\{.*\+|\.findOne\(\{.*\+|\$regex.*req\.|new RegExp\(req\.` (`**/bot/plugins/*/api/**`), no results

Searched for files matching `**/bot/plugins/dashboard/app/lib/auth*`, 1 match

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/auth.ts)

Searched for regex `new RegExp|RegExp\(|\$where|\$expr|\$function|\.aggregate|\.mapReduce|eval\(` (`**/bot/plugins/*/api/**`), 9 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/dashboard/app/lib/routePermissions.ts#195-195), lines 195 to 202

Searched for regex `req\.body|req\.query|req\.params` (`**/bot/plugins/*/api/**`), 20 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/players.ts#85-85), lines 85 to 110

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/connection.ts#30-30), lines 30 to 70

Searched for files matching `**/bot/plugins/modmail/websocket/*`, 1 match

Searched for regex `PKCE|pkce|code_challenge|code_verifier`, no results

Searched for regex `router\.(get|post|put|patch|delete)` (`**/bot/plugins/*/api/**`), 100 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/modmail/websocket/ModmailWebSocketService.ts#1-1), lines 1 to 100

Searched for regex `WebSocketServer|wss\.on|ws\.on\(|handleUpgrade|onConnection` (`**/bot/src/**`), 8 results

Searched for regex `router\.(get|post|put|patch|delete)` (`**/bot/plugins/moderation/api/locks.ts`), 5 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/players.ts#1-1), lines 1 to 20

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/WebSocketManager.ts#1-1), lines 1 to 150

Searched for regex `attachment-blocker|minigames|overview|members|channels|roles|status|locks` (`**/bot/plugins/*/api/**`), 20 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/WebSocketManager.ts#150-150), lines 150 to 280

Searched for regex `router\.use\(.*guilds.*\)|registerApiRoutes|mountRoutes|apiRouter|guildRouter`, no results

Searched for files matching `**/bot/plugins/attachment-blocker/api/*`, 9 matches

Searched for files matching `**/bot/plugins/minigames/api/*`, no matches

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/WebSocketManager.ts#280-280), lines 280 to 389

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/attachment-blocker/api/index.ts#1-1), lines 1 to 40

Searched for regex `apiRoutes|\.use\("/api/guilds|registerRoutes.*api|mountPlugin|pluginApi`, 20 results

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/moderation/api/locks.ts#1-1), lines 1 to 30

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/src/core/PermissionService.ts#1-1), lines 1 to 30

Read [](file:///c%3A/Users/Wild/Documents/GitHub/Heimdall%20PluginBased/bot/plugins/minecraft/api/players.ts#490-490), lines 490 to 510

I've completed a thorough investigation. Before finalizing the plan, I have a few questions about intent and priorities:

Asked 4 questions (Deployment, Permissions, WebSocket, Scope)

The public exposure of the bot API significantly elevates several findings. Here's the full plan:

---

## Plan: Dashboard & API Security Hardening

The audit uncovered 24 issues ranging from critical (unauthenticated API docs exposed publicly, CORS `*` on a public API, permission bypass on unmapped routes) to low (timing-safe key comparison, stale caches). The plan is organized by severity and dependency order. The core theme: the system is default-open in multiple layers and needs to become default-closed.

**Steps**

### Phase 1 — Critical (immediate)

1. **Lock down CORS on the bot API.** In src/core/ApiManager.ts, replace `Access-Control-Allow-Origin: *` with a whitelist containing only `maidbot.domain.ext` (the dashboard origin). Use the `cors` npm package with `origin: [process.env.DASHBOARD_URL]` and `credentials: true`. Add `DASHBOARD_URL` to the env config.

2. **Gate Swagger docs behind API key auth.** In src/core/ApiManager.ts, move the `/api-docs` and `/api-docs.json` mounts **after** the API key middleware, or add a standalone auth check. Since this is publicly reachable at `maidbot-api.domain.ext/api-docs`, anyone can currently enumerate every endpoint, parameter, and schema.

3. **Fix the route permission bypass.** In lib/routePermissions.ts, change the fallback at line 202 from `return null` to `return "dashboard.can_access"` (or a deny sentinel). This ensures **unmapped routes require at least basic dashboard access** instead of being open to any authenticated guild member. Then add the missing route entries for attachment-blocker, moderation locks, modmail bulk operations, minecraft requests, and tag operations.

4. **Fix regex injection (3 locations).** Add an `escapeRegex` utility and apply it:
   - minecraft/api/players.ts line 53 — search query `$regex`
   - minecraft/api/players.ts line 96 — manual add `new RegExp()`
   - minecraft/api/connection.ts lines 44 and 59 — connection lookup `new RegExp()`

   The escape pattern already exists in the bulk import at players.ts line 499 — extract it into a shared utility in `plugins/lib/utils/` and reuse.

5. **Redact health/root info endpoints.** In src/core/ApiManager.ts, remove version and router count from `/api/health` and `/` responses, or move them behind the API key middleware. On a public API, this is free reconnaissance.

### Phase 2 — High (this week)

6. **Switch permissions to default-closed.** In src/core/PermissionService.ts at line 18, change the unknown-action fallback from `return true` to `return false`. Update `buildAllowAllPermissions` to only be called for guild owners/administrators, not as the default for guilds with no permission docs. Mirror the same change in WebSocketManager.ts lines 305–317. **This is a breaking behavioral change** — guilds that currently rely on the default-open behavior will lose dashboard access until an admin configures permissions. Consider adding a migration that creates default permission docs for existing guilds.

7. **Add rate limiting.** Install `express-rate-limit` and apply it to the Express API in src/core/ApiManager.ts:
   - Global: 100 requests/minute per IP
   - Auth-sensitive routes (`/api/dashboard-access`): 20 requests/minute
   - Mutation routes (POST/PUT/DELETE): 30 requests/minute

   On the Next.js side, add rate limiting to the catch-all proxy in route.ts using an in-memory store (or Redis if available).

8. **Use constant-time comparison for API key.** In src/core/ApiManager.ts line 157, replace `key !== this.apiKey` with `crypto.timingSafeEqual(Buffer.from(key), Buffer.from(this.apiKey))`. Wrap in a try-catch for length-mismatch.

9. **Add `Content-Security-Policy` header.** In dashboard middleware.ts, add a CSP header: `default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' https://cdn.discordapp.com; connect-src 'self' wss://maidbot-ws.domain.ext`. Adjust domains as needed.

10. **Add `Strict-Transport-Security` header.** In the same middleware, add `Strict-Transport-Security: max-age=31536000; includeSubDomains` since the dashboard is served over HTTPS.

### Phase 3 — Medium (this sprint)

11. **Add Zod validation to all API routes.** Create a shared validation middleware in `src/utils/` or `plugins/lib/utils/`:

    ```
    validateBody(schema: ZodSchema) → Express middleware that parses req.body and returns 400 on failure
    ```

    Then define Zod schemas for every API route's expected body. Priority routes (highest risk from unvalidated input):
    - All minecraft plugin routes (players, connection, config)
    - All moderation routes (cases, config)
    - All modmail routes (conversations, config)
    - Welcome config update
    - Tags CRUD
    - Ticket config
    - Attachment blocker config

12. **Encrypt RCON password at rest.** The `GuildEnvService` with `ENCRYPTION_KEY` already exists for encrypting secrets (used for OpenAI keys). In MinecraftConfig.ts, use the same encryption service for `rconPassword`. Update the GET config endpoint in config.ts accordingly.

13. **Remove hardcoded Cloudflare tunnel domain.** In next.config.mjs, remove `cope-sound-amanda-thanks.trycloudflare.com` from `allowedDevOrigins`. Replace with `process.env.DEV_ORIGIN` or remove entirely — it's a development artifact.

14. **Fix `poweredByHeader` to always be false.** In next.config.mjs, move `poweredByHeader: false` outside the production conditional so it applies in all environments.

15. **Fix `dashboard-access` deny check.** In src/core/ApiManager.ts lines 365–385, the guild list endpoint should filter out guilds where the user's resolved permissions include `_deny_access: deny`. Currently it only checks role presence, not the deny flag.

16. **Handle "member not found" as access denied.** In user-permissions route lines 57–66, return a 403 instead of `permissions: {}` when member data cannot be fetched.

### Phase 4 — Low (backlog)

17. **Add WebSocket connection limits.** In WebSocketManager.ts, track connections per user ID and reject new connections beyond a threshold (e.g., 5 per user). Also add rate limiting on `auth` messages to prevent brute-force token guessing.

18. **Refresh WebSocket permissions periodically.** In WebSocketManager.ts, add a periodic re-validation (e.g., every 5 minutes) that re-fetches guild membership and permissions for connected sockets. Disconnect sockets whose users have lost access.

19. **Reduce permission cache TTL.** In the catch-all proxy route.ts, reduce the 30-second cache to 10 seconds, or add a cache invalidation mechanism triggered by permission changes.

20. **Sanitize error messages in migration endpoint.** In ApiManager.ts line 443, replace `error.message` with a generic error message in production; log the detail server-side only.

21. **Add request body size limits per route.** Add tighter `express.json({ limit: '1mb' })` overrides on routes that don't need 10MB payloads (most routes). Keep 10MB only for bulk import endpoints.

22. **Stop writing `.env.local` at runtime.** In dashboard/index.ts lines 47–71, consider passing environment variables directly to the Next.js process via `child_process.spawn` env option instead of writing secrets to disk.

23. **Upgrade `next-auth` from beta.** Monitor for a stable v5 release and upgrade when available. Beta 25 may contain undiscovered vulnerabilities.

24. **Generate a strong `INTERNAL_API_KEY` for production.** Ensure the test value `12345...` in .env is never deployed. Add a startup check in `ApiManager` that rejects obviously weak keys (e.g., all same digit, < 32 chars).

**Verification**

- After Phase 1: Confirm `/api-docs` returns 401 without API key. Confirm CORS preflight rejects non-dashboard origins. Confirm an unmapped route (e.g., `/attachment-blocker/config`) returns 403 for a non-admin. Test regex injection payloads (`.*`, `(a+)+$`) are rejected or escaped.
- After Phase 2: Confirm a guild with no permission docs denies dashboard access to regular members. Run a load test to confirm rate limiting kicks in. Check response headers for CSP and HSTS.
- After Phase 3: Send malformed JSON bodies to API routes and confirm 400 responses with Zod error details. Verify RCON password is encrypted in MongoDB. Confirm `X-Powered-By` header is absent.
- After Phase 4: Open 6+ WebSocket connections as the same user and confirm the 6th is rejected. Revoke a user's role and confirm their WebSocket disconnects within 5 minutes.

**Decisions**

- **Default-closed permissions (step 6):** Chose default-closed per your requirement. This is a breaking change for existing guilds — a migration script should create baseline permission docs for guilds that currently have none. Remeber discord Admins will still have access, unless their role is explicitly denied.
- **Unmapped route fallback (step 3):** Chose to require `dashboard.can_access` rather than hard-deny, so that legitimate but unmapped routes still work for users with basic access. Can tighten to hard-deny if preferred.
- **Zod validation (step 11):** Will add as Express middleware rather than inline checks, keeping route handlers clean.
